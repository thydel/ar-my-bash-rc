#!/bin/bash

# If this is an xterm set the title to user@host:dir
case "$TERM" in
xterm*|rxvt*)
    PROMPT_COMMAND='history -a; echo -ne "\033]0;${USER}@${HOSTNAME}: ${PWD/$HOME/~}\007"'
    ;;
#screen)
#    PROMPT_COMMAND='history -a; st'
#    ;;
*)
    PROMPT_COMMAND='history -a'
    ;;
esac

THY=thy
export HOST=$(hostname -s)
export HISTDIR=~/.bash_history.d/$HOST

export TTY=$(test -t 0 && basename $(tty) || echo no-tty)

export HISTFILE=$HISTDIR/.bash_history-$TTY
mkdir -p $HISTDIR; chown $THY $HISTDIR
touch $HISTFILE; chown $THY $HISTFILE

shopt -s histappend
shopt -s cmdhist
export HISTSIZE=50000
export HISTCONTROL=ignoreboth
export HISTTIMEFORMAT='%F+%T '

export LOGDIR=~/.bash-logs.d/$HOST
mkdir -p $LOGDIR
log () {
    h=$(history 1 | awk '{$1=_}1');
    date=$(echo $h | awk '{print$1}' | tr -d '\n');
    cmd=$(echo $h | awk '{$1=_}1' | cut -b 2-)
    echo -e "(USER=\001$USER\001 cd \001$(pwd)\001;\001$cmd\001) #\001 $date";
}
export PROMPT_COMMAND+='; log >> $LOGDIR/$TTY-$(date "+%Y-%m-%d").log'

hfa () { cat ~/.bash_history $(HISTDIR)/.bash_history-* | grep -i "$1"; }
hf () { hfa "$1" | sort -u; }

mscreen () { screen -c ~/.screenrc-$1 -RdS $1; }

sshs () { ssh -AXt -o StrictHostKeyChecking=no -o ServerAliveInterval=20 ${1:-nil} ${2:+-p $2} bash -l -i -c 'ssh_; exec screen -RdS thy'; }

stw () { echo -ne "\033]0;${USER}@${HOSTNAME}: ${PWD/$HOME/~}\007"; }
sts () { echo -ne '\ek'"${USER}@$(hostname -s): ${PWD/$HOME/~}"'\e\\'; }
st () { stw; sts; }

ssh_ () {
	SSHVARS="SSH_CLIENT SSH_TTY SSH_AUTH_SOCK SSH_CONNECTION DISPLAY"

	for x in ${SSHVARS} ; do
	    (eval echo $x=\$$x) | sed  's/=/="/
	                                s/$/"/
	                                s/^/export /'
	done 1> ~/.ssh_

	for x in ${SSHVARS} ; do
	    (eval echo $x=\$$x) | sed  's/=/" "/
	                                s/$/")/
	                                s/^/(setenv "/'
	done 1> ~/.ssh.el
}

sshh () { source ~/.ssh_; ssh-add -l; }

fixbrokengdm3 () { xauth -f ~/.Xauthority nlist | xauth nmerge -; }
rfixbrokengdm3ssh () { ssh $1 xauth merge $(ssh $1 -l root echo /var/run/gdm3/auth-for-$USER*)/database; }
mx2x () { ssh -XC $1 x2x -west -to :0; }

mscreen () { screen -c ~/.screenrc-$1 -RdS $1; }
sts2 () { echo -ne '\ek'"$1"'\e\\'; }
sshs2 () { sts2 $1; ssh -AXt -o StrictHostKeyChecking=no -o ServerAliveInterval=20 ${1:-nil} ${2:+-p $2} bash -l -i -c 'ssh_; exec screen -RdS thy'; }

showswap () { find /proc -maxdepth 2 -mmin +1 -name status | xargs grep -l VmSwap | xargs grep -h -e Name -e Swap -e Tgid | cut -d: -f2 | paste - - - | column -t | sort -nr -k3 | grep -v ' 0 '; }
